/*! Skyrim-Mod-Watcher 31-12-2014 */
function isLoggedIn(a,b,c){return a.isAuthenticated()?c():void b.redirect("/login")}module.exports=function(a,b,c){a.get("/",function(a,b){Blog.findOne({newest:!0},function(a,c){b.render("home.ejs",{title:c.title,author:c.author,thumbnailurl:c.thumbnail,date:c.date.getMonth()+1+"/"+c.date.getDate()+"/"+c.date.getFullYear(),content:c.body,login:!1,admin:!1})})}),a.get("/api/blog/newest",function(a,b){Blog.findOne({newest:!0},function(a,c){c?(b.set("Content-Type","text/json"),b.send(c)):(b.writeHead(404),b.end())})}),a.get("/admin",isLoggedIn,function(a,b){Blog.findOne({newest:!0},function(a,c){Modlist.find({},function(a,d){for(var e=[],f=d.length-1,g=0;f>d.length-6;f--,g++)e[g]=d[f].username;b.render("home.ejs",{title:c.title,author:c.author,thumbnailurl:c.thumbnail,date:c.date.getMonth()+1+"/"+c.date.getDate()+"/"+c.date.getFullYear(),content:c.body,login:!1,admin:!0,mods:e})})})}),a.get("/users",function(a,b){b.render("allusers.ejs")}),a.get("/userlist",function(a,b){Modlist.find({},function(a,c){for(var d=[],e=c.length-1,f=0;e>=0;e--,f++)d[f]=c[e].username;b.set("Content-Type","text/json"),b.send({usernames:d})})}),a.get("/scriptversion",function(a,b){b.set("Content-Type","text"),b.send(c)}),a.get("/rss",function(a,b){Blog.find({},function(a,c){if(c){var d='<rss version="2.0"><channel><title>Modwat.ch Feed</title>';d+="<description>An RSS feed to keep up with updates to Modwat.ch, a load order uploader.</description>",d+="<link>http://modwat.ch</link>",d+="<language>en-us</language>";for(var e=0;e<c.length;e++)d+="<item><title>"+c[e].title+"</title><description>"+c[e].desc+"</description>",d+="<link>http://modwat.ch/blog/"+c[e].unique+"</link><image><url>"+c[e].thumbnail+"</url></image></item>",d+="<pubDate>"+c[e].date+"</pubDate>";d+="</channel></rss>",b.set("Content-Type","text/xml"),b.send(d)}else b.writeHead("404"),b.end()})}),a.get("/login",function(a,b){Blog.findOne({newest:!0},function(a,c){Modlist.find({},function(a,d){for(var e=[],f=d.length-1,g=0;f>d.length-6;f--,g++)e[g]=d[f].username;b.render("home.ejs",{title:c.title,author:c.author,thumbnailurl:c.thumbnail,date:c.date.getMonth()+1+"/"+c.date.getDate()+"/"+c.date.getFullYear(),content:c.body,login:!0,admin:!1,mods:e})})})}),a.get("/logout",function(a,b){a.logout(),b.redirect("/")}),a.get("/blog/:unique",function(a,b){Blog.findOne({unique:a.params.unique},function(a,c){Modlist.find({},function(a,d){for(var e=[],f=d.length-1,g=0;f>d.length-6;f--,g++)e[g]=d[f].username;b.render("home.ejs",{title:c.title,author:c.author,thumbnailurl:c.thumbnail,date:c.date.getMonth()+1+"/"+c.date.getDate()+"/"+c.date.getFullYear(),content:c.body,mods:e,login:!1,admin:!1})})})}),a.get("/text/:username/:filetype",function(a,b){Modlist.findOne({username:a.params.username},function(c,d){if(d){var e;"plugins"==a.params.filetype?e=JSON.parse(d.list):"modlist"==a.params.filetype?e=JSON.parse(d.modlisttxt):"ini"==a.params.filetype?e=JSON.parse(d.skyrimini):"prefsini"==a.params.filetype&&(e=JSON.parse(d.skyrimprefsini));for(var f="# Generated by Modwat.ch<br />",g=0;g<e.length;g++)f+=e[g]+"<br />";b.send(f)}else b.writeHead("404"),b.end()})}),a.get("/json/:username",function(a,b){Modlist.findOne({username:a.params.username},function(c,d){d?b.send({username:a.params.username,mods:d.list}):(b.writeHead("404"),b.end())})}),a.get("/reddit/:username",function(a,b){Modlist.findOne({username:a.params.username},function(c,d){if(d){for(var e="# "+a.params.username+"  ",f=JSON.parse(d.list),g=0;g<f.length;g++)e+=g+1+". "+f[g]+"  ";b.send(e)}else b.writeHead("404"),b.end()})}),a.get("/logout",function(a,b){a.logout(),b.redirect("/")}),a.post("/login",b.authenticate("login",{successRedirect:"/admin",failureRedirect:"/login"})),a.get("/:username",function(a,b){Modlist.findOne({username:a.param("username")},function(a,c){c?(c.UpdateOldStyleModlist(),b.render("profile.ejs",{username:c.username,timestamp:c.timestamp.getMonth()+1+"/"+c.timestamp.getDate()+"/"+c.timestamp.getFullYear(),enb:c.enb,game:c.game})):b.redirect("/")})}),a.get("/api/:username/:filename",function(a,b){Modlist.findOne({username:a.param("username")},function(c,d){d?(b.setHeader("Content-Type","application/json"),b.end("plugins"==a.param("filename")?JSON.stringify(d.plugins):"modlist"==a.param("filename")?JSON.stringify(d.modlist):"ini"==a.param("filename")?JSON.stringify(d.ini):"prefsini"==a.param("filename")?JSON.stringify(d.prefsini):JSON.stringify([]))):(b.writeHead(404),b.end())})}),a.post("/usersearch",function(a,b){b.redirect("/"+a.body.username)}),a.post("/postnewblog",isLoggedIn,function(a,b){var c=new Blog;c.title=a.body.title,c.thumbnail=a.body.thumbnail,c.body=a.body.content.replace(new RegExp("\r?\n","g"),"<br />"),c.desc=a.body.desc,c.author=a.body.author,c.unique=a.body.thumbnail.split("/")[1].split(".")[0],c.save(function(c){if(c)throw console.log("Post Error: "+c),b.writeHead("500"),b.end(),c;console.log("New Blog Entry Uploaded By "+a.body.author),Blog.findOne({newest:!0},function(a,b){b.newest=!1,b.save()}),b.redirect("/")})}),a.post("/:username/newpass",function(a,b){Modlist.findOne({username:a.param("username")},function(c,d){d?d.validPassword(a.body.oldPassword)?(d.password=d.generateHash(a.body.newPassword),d.save(function(a){a&&console.err(a)}),b.statusCode=200,b.write("Password changed"),b.end()):(b.statusCode=403,b.write("Access denied, incorrect password"),b.end()):(b.statusCode=400,b.write("No username found"),b.end())})}),a.post("/fullloadorder",function(a,b){Modlist.findOne({username:a.body.username},function(c,d){if(d)d.validPassword(a.body.password)?(d.list=a.body.plugins,d.modlisttxt=a.body.modlisttxt,d.skyrimini=a.body.skyrimini,d.skyrimprefsini=a.body.skyrimprefsini,d.timestamp=Date.now(),d.save(function(a){a&&console.err(a)}),b.statusCode=200,b.end()):(b.statusCode=403,b.write("Access denied, incorrect password"),b.end());else{var e=new Modlist;e.list=a.body.plugins,e.modlisttxt=a.body.modlisttxt,e.skyrimini=a.body.skyrimini,e.skyrimprefsini=a.body.skyrimprefsini,e.username=a.body.username,e.timestamp=Date.now(),e.password=e.generateHash(a.body.password),e.save(function(a){if(a)throw b.statusCode=500,console.error(a),b.write(a),b.end(),a;b.statusCode=200,b.end()})}})}),a.post("/loadorder",function(a,b){Modlist.findOne({username:a.body.username},function(c,d){if(d)d.validPassword(a.body.password)?(d.UpdateOldStyleModlist(),d.plugins=a.body.plugins,d.modlist=a.body.modlist,d.ini=a.body.ini,d.prefsini=a.body.prefsini,d.enb=a.body.enb,d.game=a.body.game,d.tags=a.body.tags,d.timestamp=Date.now(),d.save(function(a){if(a)throw b.statusCode=500,console.error(a),b.write(a),b.end(),a;console.log(d.game),b.statusCode=200,b.end()})):(b.statusCode=403,b.write("Access denied, incorrect password"),b.end());else{var e=new Modlist;e.plugins=a.body.plugins,e.modlist=a.body.modlist,e.ini=a.body.ini,e.prefsini=a.body.prefsini,e.enb=a.body.enb,e.game=a.body.game,e.tags=a.body.tags,e.timestamp=Date.now(),e.username=a.body.username,e.password=e.generateHash(a.body.password),e.save(function(a){if(a)throw b.statusCode=500,console.error(a),b.write(a),b.end(),a;console.log("new user created"),b.statusCode=200,b.end()})}})}),a.post("/admin/:username/delete",isLoggedIn,function(a){Modlist.findOne({username:a.body.username},function(b,c){c?c.remove(function(a){a&&console.err(a)}):console.log("Username "+a.body.username+" not found"),b&&console.err(b)})})};var Modlist=require("./models/modlist.min.js"),Blog=require("./models/blog.min.js");