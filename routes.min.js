/*! Skyrim-Mod-Watcher 07-01-2015 */
function isLoggedIn(a,b,c){return a.isAuthenticated()?c():(b.writeHead(403),void b.end())}module.exports=function(a,b,c){a.get("/",function(a,b){Blog.findOne({newest:!0},function(c,d){b.render("home.ejs",{title:d.title,author:d.author,thumbnailurl:d.thumbnail,date:d.date.getMonth()+1+"/"+d.date.getDate()+"/"+d.date.getFullYear(),content:d.body,login:!1,admin:!1,user:void 0!=a.user?a.user.username:""})})}),a.get("/charts",function(a,b){b.render("charts.ejs",{user:void 0!=a.user?a.user.username:""})}),a.get("/api/blog/newest",function(a,b){Blog.findOne({newest:!0},function(a,c){c?(b.set("Content-Type","text/json"),b.send(c)):(b.writeHead(404),b.end())})}),a.get("/users",function(a,b){b.render("allusers.ejs")}),a.get("/userlist",function(a,b){Modlist.find({},function(a,c){for(var d=[],e=c.length-1,f=0;e>=0;e--,f++)d[f]=c[e].username;b.set("Content-Type","text/json"),b.send({usernames:d})})}),a.get("/scriptversion",function(a,b){b.set("Content-Type","text"),b.send(c)}),a.get("/rss",function(a,b){Blog.find({},function(a,c){if(c){var d='<rss version="2.0"><channel><title>Modwat.ch Feed</title>';d+="<description>An RSS feed to keep up with updates to Modwat.ch, a load order uploader.</description>",d+="<link>http://modwat.ch</link>",d+="<language>en-us</language>";for(var e=0;e<c.length;e++)d+="<item><title>"+c[e].title+"</title><description>"+c[e].desc+"</description>",d+="<link>http://modwat.ch/blog/"+c[e].unique+"</link><image><url>"+c[e].thumbnail+"</url></image></item>",d+="<pubDate>"+c[e].date+"</pubDate>";d+="</channel></rss>",b.set("Content-Type","text/xml"),b.send(d)}else b.writeHead("404"),b.end()})}),a.get("/GPUList",function(a,b){Modlist.find({},function(a,c){if(c){for(var d=0,e=0,f=[],g=0,h=0;h<c.length;h++){var i=c[h].GetGPU();if(0!=i)if(c[h].GetGPU().indexOf("NVIDIA")>=0?e++:c[h].GetGPU().indexOf("AMD")>=0&&d++,0==g)f[0]={name:i,amount:1},g++;else{for(var j=!1,k=0;g>k;k++)if(i==f[k].name){f[k].amount++,j=!0;break}j||(f[g]={name:i,amount:1},g++)}console.log("NVIDIA: "+e+"		AMD: "+d+"		tmp: "+i)}b.set("Content-Type","text/json"),b.send({NVIDIA:e,AMD:d,GPUS:f})}else b.writeHead("404"),b.end()})}),a.get("/logout",function(a,b){a.logout(),b.redirect("/")}),a.get("/blog/:unique",function(a,b){Blog.findOne({unique:a.params.unique},function(a,c){Modlist.find({},function(a,d){for(var e=[],f=d.length-1,g=0;f>d.length-6;f--,g++)e[g]=d[f].username;b.render("home.ejs",{title:c.title,author:c.author,thumbnailurl:c.thumbnail,date:c.date.getMonth()+1+"/"+c.date.getDate()+"/"+c.date.getFullYear(),content:c.body,mods:e,login:!1,admin:!1})})})}),a.get("/json/:username",function(a,b){Modlist.findOne({username:a.params.username},function(c,d){d?(d.plugins.length<1&&d.UpdateOldStyleModlist(),b.setHeader("Content-Type","application/json"),b.send({username:a.params.username,plugins:d.plugins,modlist:d.modlist,ini:d.ini,prefsini:d.prefsini})):(b.writeHead("404"),b.end())})}),a.get("/logout",function(a,b){a.logout(),b.redirect("/")}),a.post("/login",b.authenticate("login",{successRedirect:"/admin",failureRedirect:"/login"})),a.get("/:username",function(a,b){Modlist.findOne({username:a.param("username")},function(c,d){d?(d.list.length>0&&d.UpdateOldStyleModlist(),b.render("profile.ejs",{username:d.username,timestamp:d.timestamp.getMonth()+1+"/"+d.timestamp.getDate()+"/"+d.timestamp.getFullYear(),enb:d.enb,game:d.game,owner:void 0!=a.user&&a.user.username==a.param("username")?!0:!1,enb:void 0!=d.enb?d.enb:"",tag:void 0!=d.tag?d.tag:""})):b.redirect("/")})}),a.get("/api/:username/:filename",function(a,b){Modlist.findOne({username:a.param("username")},function(c,d){d?(d.plugins.length<1&&d.UpdateOldStyleModlist(),b.setHeader("Content-Type","application/json"),b.end("plugins"==a.param("filename")?JSON.stringify(d.plugins):"modlist"==a.param("filename")?JSON.stringify(d.modlist):"ini"==a.param("filename")?JSON.stringify(d.ini):"prefsini"==a.param("filename")?JSON.stringify(d.prefsini):JSON.stringify([]))):(b.writeHead(404),b.end())})}),a.post("/usersearch",function(a,b){b.redirect("/"+a.body.username)}),a.post("/newENB/:username",isLoggedIn,function(a,b){a.user.username==a.param("username")?Modlist.findOne({username:a.param("username")},function(c,d){d?(d.enb=a.body.enb,d.save(function(a){a?console.log(a):(b.statusCode=200,b.end())})):(b.writeHead(404),b.end())}):(b.writeHead(403),b.end())}),a.post("/newTag/:username",isLoggedIn,function(a,b){a.user.username==a.param("username")?Modlist.findOne({username:a.param("username")},function(c,d){d?(d.tag=a.body.tag,d.save(function(a){a?(console.log(a),b.writeHead(500),b.end()):(b.statusCode=200,b.end())})):(b.writeHead(404),b.end())}):(b.writeHead(403),b.end())}),a.post("/:username/newpass",function(a,b){Modlist.findOne({username:a.param("username")},function(c,d){d?d.validPassword(a.body.oldPassword)?(d.password=d.generateHash(a.body.newPassword),d.save(function(a){a&&console.log(a)}),b.statusCode=200,b.write("Password changed"),b.end()):(b.statusCode=403,b.write("Access denied, incorrect password"),b.end()):(b.statusCode=400,b.write("No username found"),b.end())})}),a.post("/fullloadorder",function(a,b){Modlist.findOne({username:a.body.username},function(c,d){if(d)d.validPassword(a.body.password)?(d.list=a.body.plugins,d.modlisttxt=a.body.modlisttxt,d.skyrimini=a.body.skyrimini,d.skyrimprefsini=a.body.skyrimprefsini,d.timestamp=Date.now(),d.save(function(a){if(a)throw b.statusCode=500,console.logor(a),b.write(a),b.end(),a;d.UpdateOldStyleModlist(),b.statusCode=200,b.end()})):(b.statusCode=403,b.write("Access denied, incorrect password"),b.end());else{var e=new Modlist;e.list=a.body.plugins,e.modlisttxt=a.body.modlisttxt,e.skyrimini=a.body.skyrimini,e.skyrimprefsini=a.body.skyrimprefsini,e.username=a.body.username,e.timestamp=Date.now(),e.password=e.generateHash(a.body.password),e.save(function(a){if(a)throw b.statusCode=500,console.logor(a),b.write(a),b.end(),a;e.UpdateOldStyleModlist(),b.statusCode=200,b.end()})}})}),a.post("/loadorder",function(a,b){Modlist.findOne({username:a.body.username},function(c,d){if(d)d.validPassword(a.body.password)?(d.UpdateOldStyleModlist(),d.plugins=a.body.plugins,d.modlist=a.body.modlist,d.ini=a.body.ini,d.prefsini=a.body.prefsini,d.enb=a.body.enb,d.game=a.body.game,d.tags=a.body.tags,d.timestamp=Date.now(),d.save(function(a){if(a)throw b.statusCode=500,console.logor(a),b.write(a),b.end(),a;console.log(d.game),b.statusCode=200,b.end()})):(b.statusCode=403,b.write("Access denied, incorrect password"),b.end());else{var e=new Modlist;e.plugins=a.body.plugins,e.modlist=a.body.modlist,e.ini=a.body.ini,e.prefsini=a.body.prefsini,e.enb=a.body.enb,e.game=a.body.game,e.tags=a.body.tags,e.timestamp=Date.now(),e.username=a.body.username,e.password=e.generateHash(a.body.password),e.save(function(a){if(a)throw b.statusCode=500,console.logor(a),b.write(a),b.end(),a;console.log("new user created"),b.statusCode=200,b.end()})}})})};var Blog=require("./models/blog.min.js"),Modlist=require("./models/modlist.min.js");